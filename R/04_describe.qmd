---
title: "03 - Describe data"
subtitle: "R for Bio Data Science"
format: html
date: "2023-11-14"
editor: visual
---

## Load libraries

```{r}
library("tidyverse")
library("here")
library("patchwork")
library("viridis")
library("plotly")
library("ggridges")
```

## load data

```{r}
data <- read_tsv(here("data/03_dat_augment.tsv"))
```

## Dataset dimensions

```{r}
dim(data)
```

The dataset has 81 observations and 18845 variables Each observation corresponds to a patient

## Gender and age distribution

```{r}
gender_bar <- data |>
  mutate(sex = str_to_title(sex)) |>
  ggplot(mapping = aes(
    x = sex,
    fill = sex
  )) +
  geom_bar(
    show.legend = FALSE
  ) +
  geom_bar(show.legend = FALSE) +
  geom_text(
    aes(
      label = after_stat(count)
    ),
    stat = "count",
    vjust = 1.5,
    colour = "black"
  ) +
  labs(
    title = "Amount of patients",
    subtitle = "Stratified on gender",
    y = "Count",
    x = "Gender"
  ) +
  theme(
    panel.grid.major.x = element_blank()
  ) +
  theme_minimal()

gender_age_box <- data |>
  mutate(sex = str_to_title(sex)) |>
  ggplot(mapping = aes(
    x = sex,
    y = age,
    fill = sex
  )) +
  geom_violin(
    aes(fill = sex),
    show.legend = FALSE
  ) +
  geom_jitter(
    color = "black",
    width = 0.25,
    alpha = 0.2,
    size = 4,
    show.legend = FALSE
  ) +
  ggtitle("Violinplot of the age distribution") +
  labs(
    subtitle = "Stratified on gender",
    y = "Age",
    x = "Gender",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  ) +
  theme(
    panel.grid.major.x = element_blank()
  ) +
  theme_minimal()

gender_bar + gender_age_box
ggsave(here("results/04_patient_gender_count_age_dist.png"), gender_bar + gender_age_box)
```

## Ethnicity
```{r}
race_bar <- data |>
  mutate(sex = str_to_title(sex)) |>
  ggplot(mapping = aes(
    x = ethnicity,
    fill = sex
  )) +
  geom_bar(
    alpha = 0.8,
    position = "dodge"
  ) +
  labs(
    title = "Distribution of ethnicities",
    subtitle = "Stratified on gender",
    x = "Ethnicity",
    y = "Count",
    fill = "Gender",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  ) +
  theme(
    panel.grid.major.x = element_blank()
  ) +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    vjust = -0.3,
    colour = "black",
    position = position_dodge(width = 0.9)
  )

ggsave(here("results/04_ethnicity_dist.png"), race_bar)
```

## Smoking status

```{r}
smoking_s_bar <- data |>
  mutate(
    smoking_status = if_else(
      is.na(smoking_status),
      "NA",
      str_to_title(smoking_status)
    ),
    smoking_status = factor(
      smoking_status,
      c("Current", "Former", "Never", "NA")
    )
  ) |>
  ggplot(mapping = aes(
    x = smoking_status,
    fill = smoking_status
  )) +
  geom_bar(show.legend = FALSE) +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    vjust = 1.5,
    colour = "black"
  ) +
  labs(
    title = "Distribution of type of smokers",
    y = "Count",
    x = "Smoking Status",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  ) +
  # scale_fill_brewer(palette = "Set1") + #Doesnt color NAs
  theme(
    panel.grid.major.x = element_blank()
  ) +
  theme_minimal()

smoking_s_bar
ggsave(here("results/04_smoking_status_dist.png"), smoking_s_bar)
```

```{r}
race_bar_faceted <- race_bar +
  facet_wrap(~smoking_status) +
  labs(subtitle = "Stratified on gender and smoking status")
race_bar_faceted
```

### Cigarette use

```{r}
yearly_smoke <- data |>
  ggplot(aes(x = after_stat(density), y = smoking_history_pack_years)) +
  geom_density(alpha = 0.5, alpha = 0.6, fill = "#FF5733") +
  geom_histogram(
    binwidth = 5,
    fill = "white",
    color = "black",
    alpha = 0.2
  ) +
  theme_minimal() +
  coord_flip() +
  labs(
    title = "Histogram of Packs Smoked Per Year",
    x = "",
    y = "Packs per Year",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  )

yearly_smoke
ggsave(here("results/04_smoking_status_dist.png"), smoking_s_bar)
```

There are 30 patients that haven't specified the amount of packs they smoke a year (NA).

```{r}
data <- data |>
  mutate(
    treatment_group = case_when(
      is.na(chemotherapy_neo_adjuvant_yes_no) | is.na(chemotherapy_yes_no) | is.na(radiation_yes_no) ~ "Data Missing",
      chemotherapy_neo_adjuvant_yes_no == "yes" & chemotherapy_yes_no == "yes" & radiation_yes_no == "yes" ~ "All Treatments",
      chemotherapy_neo_adjuvant_yes_no == "yes" & chemotherapy_yes_no == "yes" & radiation_yes_no == "no" ~ "Chemo with Neoadjuvants",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "yes" & radiation_yes_no == "yes" ~ "Chemo and Radiation",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "yes" & radiation_yes_no == "no" ~ "Chemo Only",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "no" & radiation_yes_no == "yes" ~ "Radiation Only",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "no" & radiation_yes_no == "no" ~ "No treatment",
      TRUE ~ "Other Combinations"
    )
  ) |>
  drop_na(overall_survival_months) # Drop NA values for the variable to be plotted

```

Created new column for overview of treatment type.

```{r}
# Create the ridgeline plot
ridgeline_plot <- data |>
  # Remove the groups with no entries
  filter(
    treatment_group != "Radiation Only",
    treatment_group != "All Treatments",
    treatment_group != "Other Combinations"
  ) |>
  ggplot(mapping = aes(
    x = overall_survival_months,
    y = treatment_group,
    fill = treatment_group
  )) +
  geom_density_ridges(alpha = 0.6) +
  scale_fill_brewer(
    palette = "Set3",
    name = "Treatment type"
  ) + # Choose a color palette
  theme_ridges(center_axis_labels = TRUE) + # Use the theme specifically designed for ridgeline plots
  theme(
    text = element_text(size = 10)
  ) + # Increase base text size for a larger appearance
  labs(
    title = "Overall Survival Months by Treatment type",
    x = "Overall Survival Months",
    y = "",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  )


# Display the plot
ridgeline_plot

```

```{r}
# Use t-test to investigate difference between groups
t_result <- t.test(smoking_history_pack_years ~ status_at_time_of_last_follow_up,
  data = data, na.rm = TRUE
)

# Calculate means
means <- data |>
  mutate(smoking_history_pack_years = case_when(
    smoking_history_pack_years == "10>PY" ~ 10,
    TRUE ~ as.numeric(smoking_history_pack_years)
  )) |>
  group_by(status_at_time_of_last_follow_up) |>
  summarise(
    mu = mean(smoking_history_pack_years, na.rm = TRUE),
    label = sprintf("mean[%s] == %0.2f", status_at_time_of_last_follow_up, mu)
  ) |>
  unique()
means

survival_boxplot_jitter <- data |>
  mutate(smoking_history_pack_years = case_when(
    smoking_history_pack_years == "10>PY" ~ 10,
    TRUE ~ as.numeric(smoking_history_pack_years)
  )) |>
  drop_na(smoking_history_pack_years) |>
  ggplot(aes(
    x = status_at_time_of_last_follow_up,
    y = smoking_history_pack_years
  )) +
  geom_violin(
    aes(fill = status_at_time_of_last_follow_up),
    na.rm = TRUE
  ) +
  geom_boxplot(
    # aes(#fill = status_at_time_of_last_follow_up),
    alpha = 0.2,
    outlier.shape = NA,
    width = 0.5
  ) +
  geom_jitter(
    aes(color = status_at_time_of_last_follow_up),
    width = 0.1,
    alpha = 0.2,
    size = 4
  ) +
  scale_fill_brewer(palette = "Set3") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  labs(
    title = "Smoking History and Patient Survival Status",
    subtitle = "Distribution of packs per year smoked across survival statuses",
    x = "Status at Time of Last Follow-Up",
    y = "Smoking History (Packs per Year)",
    fill = "Survival Status",
    color = "Survival Status",
    caption = "Data from DOI: https://doi.org/10.1038/nature14664"
  ) +
  theme(legend.position = "bottom")


survival_boxplot_jitter +
  geom_point(
    data = means,
    mapping = aes(
      x = status_at_time_of_last_follow_up,
      y = mu
    ),
    color = "purple",
    size = 3
  ) +
  geom_label(
    data = means,
    mapping = aes(
      x = status_at_time_of_last_follow_up,
      y = mu,
      label = label
    ),
    parse = TRUE,
    fill = "white",
    hjust = 0.1,
    vjust = 0.1
  )
```
