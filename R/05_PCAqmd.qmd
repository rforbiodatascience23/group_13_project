---
title: "05 PCA"
subtitle: "R for Bio Data Science"
format: html
author: All
date: "2023-11-15"
editor: visual
---

## Load libraries

```{r}
library("tidyverse")
library("here")
library("readxl")
library("tidyclust")
library("tidymodels")
library("corrr")

library("caret")

source(here("R/99_proj_func.R"))

```

## Load data

```{r}
# Load data
data <- read_tsv(here("data/04_dat_augment.tsv"))
```

## Feature selection

A reduciton of features is needed to do a PCA, and reduce overfitting. It will be done looking at corelations between the genes and filtering genes which highly corelations while keeping one to represent those features.

Others ways could be inspetion of heatmap of correlation, Recursive feture elimintaion and more. Due to time contrains these will not be investigtated during this projekt.

```{r}
# Look at only gene data

features_to_select <- data |>
  select(-c(1:31))

features_to_select_none_na <- features_to_select |> 
  select_if(
    ~ !any(is.na(.))
    ) 

features_to_select_fully_clear <- features_to_select|>
  select_if(
    is.numeric
    )

# Set diagoanl to 1 so findCorrelations can work

feature_cor <- features_to_select |>
  correlate(diagonal = 1)


feature_cor |>
  select(-c(1)) |>
  findCorrelation(
    cutoff = 0.9
  )

feature_cor_none <- feature_cor |>
    select_if(
    is.numeric
    )


feature_cor |>
  select(-c(1))

cor_index <- findCorrelation(feature_cor_none,cutoff = 0.9,)


# feature_cor_2 <- feature_cor|>
#   mutate_all(
#     funs(
#       replace_na(., 1)
#       )
#     )

# 
# feature_cor2 <- features_to_select |>
#   cor()
# 
# findCorrelation(feature_cor2,cutoff = 0.9)
# 
# feature_cor2

```

## PCA

Now we look

```{r}

input_pca <- data |>
  select(-c(1:31))


pca_fit <- log2(input_pca + 1e-10) |>
  prcomp()


plot_pca_hc <- pca_fit |>
  augment(data) |> 
  ggplot(aes(.fittedPC1, .fittedPC2, color = hc_cluster)) + #look at survial or hc_cluster
  geom_point(size = 1.5) +
  theme_half_open(12) +
  background_grid()

plot_pca_hc

plot_pca_sur <- pca_fit |>
  augment(data) |> 
  ggplot(aes(.fittedPC1, .fittedPC2, color = survial)) + #look at survial or hc_cluster
  geom_point(size = 1.5) +
  theme_half_open(12) +
  background_grid()

plot_pca_sur


```

```{r}
pca_fit |>
  tidy("pcs") |> 
  mutate(percent = percent * 100) |> 
  ggplot(aes(x = PC,
             y = percent)) +
  geom_hline(yintercept = 0) +
  geom_col(colour = "black",
           alpha = 0.5) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) +
  labs(title = "Scree Plot of PCA of BLOSUM62")
```
