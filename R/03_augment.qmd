---
title: "03 Augment data"
subtitle: "R for Bio Data Science"
format: html
author: All
date: "2023-11-15"
editor: visual
---

## Load libraries

```{r}
library("tidyverse")
library("here")
library("readxl")
library("tidyclust")
library("tidymodels")
source(here("R/99_proj_func.R"))
library('profmem')
```

## Set seed for reproducibility

```{r}
set.seed(1337)
```

## Load clean data

```{r}
# Load data
data_clean <- read_tsv(here("data/02_dat_clean.tsv"))
```

# Add categorical progression

Add columns of progression as categorical from a continues variable

## Add categorical survival status

```{r}
# adds cataorical colum surviral based on how many months a person survived.
# adds after meta data colums to keep structure of meta - gene data
data_survival <- data_clean |>
  mutate(
    survival_time = case_when(
      overall_survival_months < 6 ~ "Terrible",
      overall_survival_months < 12 ~ "Bad",
      overall_survival_months < 36 ~ "Decent",
      overall_survival_months < 60 ~ "Good",
      overall_survival_months >= 60 ~ "Great"
    ),
    .after = overall_survival_months
  )

# Make the survival status in boolean format
data_survival_bool <- data_survival |>
  mutate(
    survival_status = case_when(
      status_at_time_of_last_follow_up == "dead" ~ 0,
      status_at_time_of_last_follow_up == "alive" ~ 1
    ),
    .after = status_at_time_of_last_follow_up
  )
```

```{r}
data_treatment <- data_survival_bool |>
  mutate(
    treatment_group = case_when(
      is.na(chemotherapy_neo_adjuvant_yes_no) | is.na(chemotherapy_yes_no) | is.na(radiation_yes_no) ~ "Data Missing",
      chemotherapy_neo_adjuvant_yes_no == "yes" & chemotherapy_yes_no == "yes" & radiation_yes_no == "yes" ~ "All Treatments",
      chemotherapy_neo_adjuvant_yes_no == "yes" & chemotherapy_yes_no == "yes" & radiation_yes_no == "no" ~ "Chemo with Neoadjuvants",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "yes" & radiation_yes_no == "yes" ~ "Chemo and Radiation",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "yes" & radiation_yes_no == "no" ~ "Chemo Only",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "no" & radiation_yes_no == "yes" ~ "Radiation Only",
      chemotherapy_neo_adjuvant_yes_no == "no" & chemotherapy_yes_no == "no" & radiation_yes_no == "no" ~ "No treatment",
      TRUE ~ "Other Combinations"
    ),
    .after = survival_status
  )

# View changes
data_treatment |>
  select(
    survival_time,
    survival_status,
    treatment_group
  )
```


# Create a subset of relevant transcripts

We want to create a subset of transcripts that have a low-high expression signature across samples. To find transcripts with low-high expression signature, we perform a kmeans clustering on each transcripts expression data, clustering the expression values into two states. The low-high expression signature transcripts are selected based the following requirements from the cluster states.

-   Only transcripts with at least 6 samples in each state should are continued with
-   Transcripts are required to have a state-average fold change larger than 3 between the two states
-   Perform test-t between values in each state, do false discovery rate correction and keep only transcript with q \> 0.01

## Get expression data from all data

```{r}
expression_data <- data_treatment |>
  select(1, 33:ncol(data_treatment))

# Print expression_data
expression_data
```

## Log transform and transpose data to have transcript per row

```{r}
expr_log_trans <- expression_data |>
  group_by(sample_id) |>
  pivot_longer(-sample_id,
    names_to = "transcript_id",
    values_to = "expression_value"
  ) |>
  mutate(expression_value = log2(1 + expression_value)) |>
  pivot_wider(
    names_from = sample_id,
    values_from = expression_value
  ) |>
  ungroup()

expr_log_trans
```

## Filter away transcripts with only zeros

```{r}
expr_trans_no_zero <- expr_log_trans |>
  filter(!if_all(starts_with("S"), ~ . == 0))
```

## Kmeans clustering on each transcript

For each individual transcript we split the expression values into two states, which should correspond to a high and low expression state.

```{r kmeans-chunk-slow-takes-time}
# Perform kmeans clustering on each transcript
clust_data <- expr_trans_no_zero |>
  group_by(transcript_id) |>
  nest() |>
  mutate(data = map(
    .x = data,
    .f = ~ kmeans_cluster_row(.x)
  )) |>
  unnest(data) |>
  ungroup()

# Go to long format
clust_data_long <- clust_data |>
  pivot_longer(
    cols = -c(transcript_id, cluster_int),
    names_to = "sample_id",
    values_to = "expression_value"
  ) |>
  drop_na()
```

## Select transcripts according to requirements

```{r}
# Calculate average fold change in expression
avg_fold_change <- clust_data_long |>
  group_by(transcript_id, cluster_int) |>
  summarize(avg_expression = mean(expression_value)) |>
  ungroup(cluster_int) |>
  pivot_wider(
    names_from = cluster_int,
    values_from = avg_expression
  ) |>
  rename(
    cluster_1_avg_expr = "1",
    cluster_2_avg_expr = "2"
  ) |>
  mutate(fold_change = map2(
    .x = cluster_1_avg_expr,
    .y = cluster_2_avg_expr,
    .f = ~ fold_change(
      val_1 = .x,
      val_2 = .y
    )
  )) |>
  ungroup()

# Save a list of transcript following
# average expression fold change > 3
above_fold_change_threshold <- avg_fold_change |>
  filter(!fold_change == Inf) |>
  filter(fold_change > 3) |>
  pull(transcript_id)

# 6 expression values in each state check
count_clusters <- clust_data_long |>
  filter(transcript_id %in% above_fold_change_threshold) |>
  group_by(transcript_id) |>
  summarize(
    cluster1_n = sum(cluster_int == 1),
    cluster2_n = sum(cluster_int == 2)
  ) |>
  ungroup()

# Save a list of transcript ids which have 6 or more
# expression values in each state
more_than_6_in_each_cluster <- count_clusters |>
  filter(cluster1_n >= 6 & cluster2_n >= 6) |>
  pull(transcript_id)

# Perform t-test and calculate false discovery rate q-values
clust_data_long_test <- clust_data_long |>
  filter(transcript_id %in% more_than_6_in_each_cluster) |>
  group_by(transcript_id) |>
  summarize(p_value = t.test(expression_value ~ cluster_int)$p.value) |>
  mutate(q_value = p.adjust(p_value, method = "BH"))

# Save a list of
below_q_value <- clust_data_long_test |>
  filter(q_value < 0.01) |>
  pull(transcript_id)

selected_transcripts <- below_q_value
```

## Find genes with multiple transcripts (?)

```{r}
#| eval: false
#| echo: false
# check how many genes
selected_transcript_expr_split <- selected_transcript_expr |>
  separate(transcript_id, into = c("gene", "id"), sep = "_", extra = "merge")

selected_transcript_expr_split |>
  group_by(gene) |>
  summarise(n = n()) |>
  arrange(desc(n))
```

## Fishers exact test (?)

```{r}
#| eval: false
#| echo: false

below_q_value <- c(
  "ASCL1_NM_004316", "AVP_NM_000490", "AZGP1_NM_001185", "BEX1_NM_018476", "C11orf53_NM_198498", "CALML3_NM_005185", "CALML5_NM_017422", "CD164_NM_001142404", "CDKN2A_NM_058195", "CEACAM5_NM_004363", "CHGA_NM_001275", "CSAG1_NM_001102576",
  "DDC_NM_000790", "DLK1_NM_003836", "EEF1A2_NM_001958", "FABP7_NM_001446", "FOXI1_NM_012188", "GHRH_NM_021081",
  "GNG8_NM_033258", "GRP_NM_001012513", "GRP_NM_002091", "GUCA1A_NM_000409", "HLA-DRB1_NM_001243965", "HLA-DRB1_NM_002124",
  "IGLL5_NM_001178126", "MAGEA10_NM_021048", "MAGEA1_NM_004988", "MAGEA3_NM_005362", "MAGEA4_NM_001011549", "MAGEA6_NM_005363",
  "MCL1_NM_001197320", "MEST_NM_002402", "MEST_NM_177525", "MS4A15_NM_152717", "MS4A8B_NM_031457", "NTS_NM_006183",
  "PKM2_NM_182471", "POU2F3_NM_014352", "PQBP1_NM_001032382", "RPL11_NM_001199802", "RPL9_NM_000661", "RPS28_NM_001031",
  "RPS4Y1_NM_001008", "RTN1_NM_206852", "SCGB1A1_NM_003357", "SCGB3A2_NM_054023", "SCGN_NM_006998", "SFTPA1_NM_001164647",
  "SFTPA1_NM_005411", "SFTPA2_NM_001098668", "SFTPB_NM_000542", "SFTPB_NM_198843", "SFTPC_NM_001172357", "SFTPC_NM_001172410",
  "SFTPC_NM_003018", "SPRR2A_NM_005988", "SPRR2F_NM_001014450", "SST_NM_001048", "STMN2_NM_007029", "TFF3_NM_003226"
)
```

```{r}
#clust_data_long |>
#  filter(transcript_id %in% below_q_value) |> 
#  write_tsv('quick.tsv')

clust_data_long <- read_tsv("quick.tsv")

# Find which states are high and which are low via state averages
avg_expression_clust <- clust_data_long |>
  filter(transcript_id %in% below_q_value) |>
  group_by(transcript_id, cluster_int) |>
  summarize(avg_expression = mean(expression_value)) |>
  ungroup() |>
  pivot_wider(
    names_from = cluster_int,
    values_from = avg_expression
  ) |>
  rename(
    cluster_1 = "1",
    cluster_2 = "2"
  )

avg_expression_clust
```

```{r}
# Select 1 if cluster is of high expression value cluster and
# 0 if cluster is the low expression values cluster for each transcript
which_clust_high_low <- avg_expression_clust |>
  group_by(transcript_id) |>
  summarise(
    avg_max = max(c(cluster_1, cluster_2)),
    cluster_1_cat = ifelse(avg_max == cluster_1,
      1,
      0
    ),
    cluster_2_cat = ifelse(avg_max == cluster_2,
      1,
      0
    )
  ) |>
  select(transcript_id, cluster_1_cat, cluster_2_cat)

which_clust_high_low
```

```{r}
# Transform cluster_int values to high (1) or low (0) expression categories
high_low_clustering <- clust_data_long |>
  filter(transcript_id %in% below_q_value) |>
  left_join(which_clust_high_low,
    by = "transcript_id"
  ) |>
  mutate(high_low_clust = case_when(
    cluster_int == 1 & cluster_1_cat == 1 ~ 1,
    cluster_int == 2 & cluster_2_cat == 1 ~ 1,
    cluster_int == 1 & cluster_1_cat == 0 ~ 0,
    cluster_int == 2 & cluster_2_cat == 0 ~ 0
  )) |>
  select(sample_id, transcript_id, high_low_clust)

high_low_clustering

high_low_clustering |>
  pivot_wider(names_from = transcript_id,
              values_from = high_low_clust) |>
  select(sample_id, TFF3_NM_003226, ASCL1_NM_004316) |>
  as.data.frame() -> tester

tester
```

```{r}
# Sample data
set.seed(143)
gene_data <- data.frame(
  sample_id = rep(c(
    "Sample1", "Sample2", "Sample3",
    "Sample4", "Sample5", "Sample6",
    "Sample7", "Sample8", "Sample9",
    "Sample10", "Sample11", "Sample12",
    "Sample13", "Sample14", "Sample15",
    "Sample18", "Sample19", "Sample18",
    "Sample19", "Sample20", "Sample21",
    "Sample22", "Sample23", "Sample24",
    "Sample25", "Sample26", "Sample27",
    "Sample28", "Sample29", "Sample30"
  ), each = 1),
  trans_1 = sample(c(0, 1), 30, replace = TRUE),
  trans_2 = sample(c(0, 1), 30, replace = TRUE),
  trans_3 = sample(c(0, 1), 30, replace = TRUE),
  trans_4 = sample(c(0, 1), 30, replace = TRUE),
  trans_5 = sample(c(0, 1), 30, replace = TRUE),
  trans_6 = sample(c(0, 1), 30, replace = TRUE),
  trans_7 = sample(c(0, 1), 30, replace = TRUE),
  trans_8 = sample(c(0, 1), 30, replace = TRUE),
  trans_9 = sample(c(0, 1), 30, replace = TRUE),
  trans_10 = sample(c(0, 1), 30, replace = TRUE),
  trans_11 = sample(c(0, 1), 30, replace = TRUE),
  trans_12 = sample(c(0, 1), 30, replace = TRUE),
  trans_13 = sample(c(0, 1), 30, replace = TRUE),
  trans_14 = sample(c(0, 1), 30, replace = TRUE),
  trans_15 = sample(c(0, 1), 30, replace = TRUE),
  trans_16 = sample(c(0, 1), 30, replace = TRUE),
  trans_17 = sample(c(0, 1), 30, replace = TRUE),
  trans_18 = sample(c(0, 1), 30, replace = TRUE),
  trans_19 = sample(c(0, 1), 30, replace = TRUE),
  trans_20 = sample(c(0, 1), 30, replace = TRUE),
  trans_21 = sample(c(0, 1), 30, replace = TRUE),
  trans_22 = sample(c(0, 1), 30, replace = TRUE),
  trans_23 = sample(c(0, 1), 30, replace = TRUE),
  trans_24 = sample(c(0, 1), 30, replace = TRUE),
  trans_25 = sample(c(0, 1), 30, replace = TRUE),
  trans_26 = sample(c(0, 1), 30, replace = TRUE),
  trans_27 = sample(c(0, 1), 30, replace = TRUE),
  trans_28 = sample(c(0, 1), 30, replace = TRUE),
  trans_29 = sample(c(0, 1), 30, replace = TRUE),
  trans_30 = sample(c(0, 1), 30, replace = TRUE)
  # ... add more genes as needed
)

# Print the data
print(gene_data)
print(tester)

# Reshape data for easier analysis
gene_data_long <- gene_data %>%
  pivot_longer(cols = -sample_id, names_to = "transcript_id", values_to = "high_low_clust")

tester_long <- tester |>
  pivot_longer(cols = -sample_id, names_to = "transcript_id", values_to = "high_low_clust")

#colnames(gene_data_long) == colnames(high_low_clustering)
#class(gene_data_long) == class(high_low_clustering)

gene_data_long |>
  mutate(high_low_clust = as.factor(high_low_clust),
         sample_id = as.factor(sample_id)) -> fct_gene

tester_long |>
  mutate(high_low_clust = as.factor(high_low_clust),
         sample_id = as.factor(sample_id)) -> fct_clus

fct_gene
fct_clus
```

```{r}
# Perform Fisher's exact test for each gene
fisher_results <- fct_clus |>
  group_by(transcript_id) |>
  summarise(
    p_value = fisher.test(x = high_low_clust,
                          y = sample_id,
                          simulate.p.value = TRUE,
                          B = 100000
                          )$p.value
    )


# Print the results
print(fisher_results)

# Visualize the results
fisher_results |>
  ggplot(aes(x = transcript_id, y = -log10(p_value))) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Fisher's Exact Test for transcript Expression",
    x = "transcript_id",
    y = "-log10(p-value)"
  )

?fisher.test
```

```{r}
# Sample data
set.seed(123)
gene_data <- data.frame(
  Gene = paste0("Gene", 1:100),
  State = sample(0:1, 100, replace = TRUE),
  Cluster1 = sample(1:2, 100, replace = TRUE),
  Cluster2 = sample(1:2, 100, replace = TRUE)
  # ... add more clusters as needed
)

gene_data

# Function to perform Fisher's exact test
perform_fisher_test <- function(data, gene, reference_gene) {
  contingency_table <- table(data[[gene]], data[[reference_gene]])
  fisher_result <- fisher.test(contingency_table)
  return(fisher_result$p.value)
}

# Select genes based on Fisher's exact test
selected_genes <- gene_data %>%
  select(Gene, State, starts_with("Cluster")) %>%
  group_by(Gene) %>%
  filter(sum(State == 1) > 6, sum(State == 0) > 6) %>%
  filter(across(starts_with("Cluster"), ~perform_fisher_test(data = gene_data, gene = ., reference_gene = "State") <= 1e-6)) %>%
  pull(Gene)

# Print selected genes
print(selected_genes)

```

## Pivot to sample per row

```{r}
selected_transcript_expr <- expr_log_trans |>
  filter(transcript_id %in% selected_transcripts)

selected_transcript_sample_row <- selected_transcript_expr |>
  pivot_longer(
    cols = -transcript_id,
    names_to = "sample_id",
    values_to = "expression_value"
  ) |>
  pivot_wider(
    names_from = transcript_id,
    values_from = expression_value
  )
```

## Clustering of sample ids via hierarchical clustering

Perform clustering of the gene/transcripts express to see which samples might form a subtype of cancer. The clustering will be performed using the tidyclust packages.

```{r}
# First define how to cluster
# num_cluster are the numbers of clsuters to be formed
# Linage_mehtod is which method the formations of clusted should be based on.
hc_data <- selected_transcript_sample_row

hc_spec <- hier_clust(
  num_clusters = 4,
  linkage_method = "ward.D"
)

hc_spec_fit <- hc_spec |>
  fit(~., data = hc_data)

assigned_clusters <- extract_cluster_assignment(hc_spec_fit) |>
  pluck(".cluster")

assigned_clusters |>
  as_tibble()
```

## Save selected transcripts expression data to csv

We write a tsv with all metadata for sample ids, but only keep selected transcripts.

The expression values are not log-transformed, since this could be done differently in the analysis.

Along with this we also save the hierarchical clustering amongst the sample ids.

```{r}
select_transcript_meta <- data_treatment |>
  select(c(1:32, selected_transcripts)) |>
  mutate(
    sample_cluster = assigned_clusters,
    .after = survival_time
  )

# Save augmented data
write_tsv(
  select_transcript_meta,
  here("data/03_dat_augment.tsv")
)
```